# Claude Desktop 配置文件使用说明

## 方式一：完整配置（替换现有配置）

如果你的 `claude_desktop_config.json` 文件不存在或你想完全替换：

**macOS配置文件位置：**
```
~/Library/Application Support/Claude/claude_desktop_config.json
```

**完整内容：**
```json
{
  "mcpServers": {
    "kali": {
      "command": "ssh",
      "args": [
        "wooluo@10.211.55.4",
        "cd /home/wooluo/kali && source venv/bin/activate && python -m kali_mcp.server"
      ],
      "env": {
        "LOG_LEVEL": "INFO"
      }
    }
  }
}
```

## 方式二：添加到现有配置

如果你已经有其他MCP服务器配置，只需添加 "kali" 部分：

```json
{
  "mcpServers": {
    "你的其他服务器": {
      ...
    },
    "kali": {
      "command": "ssh",
      "args": [
        "wooluo@10.211.55.4",
        "cd /home/wooluo/kali && source venv/bin/activate && python -m kali_mcp.server"
      ],
      "env": {
        "LOG_LEVEL": "INFO"
      }
    }
  }
}
```

## 方式三：使用SSH密钥（无需密码登录）

如果你已设置SSH密钥认证，配置相同，但连接更快速：

```json
{
  "mcpServers": {
    "kali": {
      "command": "ssh",
      "args": [
        "wooluo@10.211.55.4",
        "cd /home/wooluo/kali && source venv/bin/activate && python -m kali_mcp.server"
      ],
      "env": {
        "LOG_LEVEL": "INFO"
      }
    }
  }
}
```

### 设置SSH密钥（可选，推荐）

在macOS上执行：
```bash
# 生成SSH密钥（如果还没有）
ssh-keygen -t ed25519

# 复制公钥到Kali
ssh-copy-id wooluo@10.211.55.4
```

## 方式四：使用systemd服务（如果已在Kali上安装服务）

如果你在Kali上运行了 `./install_service_current.sh`，也可以直接连接服务：

```json
{
  "mcpServers": {
    "kali": {
      "command": "ssh",
      "args": [
        "wooluo@10.211.55.4",
        "systemctl status kali-mcp"
      ],
      "env": {
        "LOG_LEVEL": "INFO"
      }
    }
  }
}
```

## 如何应用配置

### 选项1：使用命令行编辑器

```bash
# 在macOS上执行
nano ~/Library/Application\ Support/Claude/claude_desktop_config.json
```

粘贴配置内容，然后按 `Ctrl+O` 保存，`Ctrl+X` 退出。

### 选项2：使用文本编辑器

```bash
# 使用VS Code
code ~/Library/Application\ Support/Claude/claude_desktop_config.json

# 或使用其他编辑器
open ~/Library/Application\ Support/Claude/claude_desktop_config.json
```

### 选项3：直接写入（简单快速）

```bash
cat > ~/Library/Application\ Support/Claude/claude_desktop_config.json << 'EOF'
{
  "mcpServers": {
    "kali": {
      "command": "ssh",
      "args": [
        "wooluo@10.211.55.4",
        "cd /home/wooluo/kali && source venv/bin/activate && python -m kali_mcp.server"
      ],
      "env": {
        "LOG_LEVEL": "INFO"
      }
    }
  }
}
EOF
```

## 验证配置

检查配置文件是否正确：

```bash
# 查看配置内容
cat ~/Library/Application\ Support/Claude/claude_desktop_config.json

# 验证JSON格式
python3 -m json.tool ~/Library/Application\ Support/Claude/claude_desktop_config.json
```

## 启动和测试

1. **重启Claude Desktop**
   - 完全退出应用（Cmd+Q）
   - 重新启动

2. **在Claude对话中测试**
   ```
   "你好Kali，列出可用的工具"
   "将'Hello Kali'编码为Base64"
   "查询 example.com 的WHOIS信息"
   ```

## 故障排除

### 问题1：SSH连接失败

```bash
# 在macOS上测试SSH连接
ssh wooluo@10.211.55.4 "echo '连接成功'"
```

### 问题2：MCP服务器未启动

在Kali上检查：
```bash
# 检查服务状态（如果安装了服务）
sudo systemctl status kali-mcp

# 或手动测试
cd /home/wooluo/kali
source venv/bin/activate
python -m kali_mcp.server
```

### 问题3：路径错误

确认Kali上的路径：
```bash
# 在Kali上执行
pwd  # 应该显示 /home/wooluo/kali
ls -la kali_mcp/  # 确认项目文件存在
```

### 问题4：权限错误

确保虚拟环境有执行权限：
```bash
# 在Kali上
cd /home/wooluo/kali
chmod +x venv/bin/python
chmod +x venv/bin/activate
```

## 查看日志

### 在Kali上查看服务器日志

```bash
# 查看MCP服务器日志
tail -f /var/log/kali_mcp.log

# 如果使用systemd服务
sudo journalctl -u kali-mcp -f
```

### 在Claude Desktop上查看日志

Claude Desktop日志位置：
```
~/Library/Logs/Claude/
```

## 高级配置（可选）

### 增加超时时间

如果SSH连接超时：

```json
{
  "mcpServers": {
    "kali": {
      "command": "ssh",
      "args": [
        "-o", "ConnectTimeout=30",
        "-o", "ServerAliveInterval=60",
        "wooluo@10.211.55.4",
        "cd /home/wooluo/kali && source venv/bin/activate && LOG_LEVEL=DEBUG python -m kali_mcp.server"
      ]
    }
  }
}
```

### 添加更多环境变量

```json
{
  "mcpServers": {
    "kali": {
      "command": "ssh",
      "args": [
        "wooluo@10.211.55.4",
        "cd /home/wooluo/kali && source venv/bin/activate && python -m kali_mcp.server"
      ],
      "env": {
        "LOG_LEVEL": "DEBUG",
        "MCP_CONFIG_PATH": "/home/wooluo/kali/config.yaml"
      }
    }
  }
}
```

## 安全提示

1. **使用SSH密钥**代替密码登录
2. **限制SSH访问** - 只允许特定IP连接
3. **定期更新**系统和依赖
4. **监控日志**文件，检测异常活动

---

**推荐方式**: 使用 `方式一` 或 `方式三（命令行直接写入）` 最简单快捷！
